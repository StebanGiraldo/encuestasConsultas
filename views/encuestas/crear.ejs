<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Crear Encuesta</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    let contadorPreguntas = 0;

    function agregarPregunta() {
      const container = document.getElementById('preguntas-container');
      const preguntaHtml = `
        <div class="border p-4 rounded bg-gray-50 mb-4 shadow" id="pregunta-${contadorPreguntas}">
          <label class="font-semibold block mb-1">Título de la Pregunta:</label>
          <input type="text" name="preguntas[${contadorPreguntas}][texto]" class="w-full p-2 border rounded mb-2" required>

          <label class="font-semibold block mb-1">Tipo de Pregunta:</label>
          <select name="preguntas[${contadorPreguntas}][tipo]" onchange="gestionarTipo(${contadorPreguntas})"
                  class="w-full p-2 border rounded mb-2" required>
              <option value="abierta">Abierta</option>
              <option value="cerrada">Cerrada</option>
              <option value="escala">Escala</option>
          </select>

          <div id="opciones-${contadorPreguntas}" class="mb-2 hidden">
              <label class="font-semibold block mb-1">Opciones (solo para preguntas cerradas):</label>
              <div id="lista-opciones-${contadorPreguntas}" class="space-y-1"></div>
              <button type="button" onclick="agregarOpcion(${contadorPreguntas})"
                      class="mt-1 text-sm text-purple-600 hover:underline">Agregar Opción</button>
          </div>

          <div id="escala-${contadorPreguntas}" class="mb-2 hidden">
              <label class="font-semibold block mb-1">Escala de Valores:</label>
              <input type="number" name="preguntas[${contadorPreguntas}][escalaMin]" placeholder="Mín"
                     class="w-1/2 p-2 border rounded mb-1">
              <input type="number" name="preguntas[${contadorPreguntas}][escalaMax]" placeholder="Máx"
                     class="w-1/2 p-2 border rounded mb-1">
          </div>

          <button type="button" onclick="eliminarPregunta(${contadorPreguntas})"
                  class="mt-2 text-red-500 hover:underline">Eliminar Pregunta</button>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', preguntaHtml);
      contadorPreguntas++;
    }

    function gestionarTipo(index) {
      const tipo = document.querySelector(`select[name="preguntas[${index}][tipo]"]`).value;
      document.getElementById(`opciones-${index}`).style.display = tipo === "cerrada" ? "block" : "none";
      document.getElementById(`escala-${index}`).style.display = tipo === "escala" ? "block" : "none";
    }

    function agregarOpcion(index) {
      const listaOpciones = document.getElementById(`lista-opciones-${index}`);
      const id = Date.now() + Math.floor(Math.random() * 1000);
      const opcionHtml = `
        <div id="opcion-${id}" class="flex items-center gap-2">
          <input type="text" name="preguntas[${index}][opciones][]" placeholder="Nueva opción"
                 class="p-2 border rounded w-full">
          <button type="button" onclick="eliminarOpcion(${id})" class="text-red-500 text-lg">❌</button>
        </div>
      `;
      listaOpciones.insertAdjacentHTML('beforeend', opcionHtml);
    }

    function eliminarPregunta(index) {
      const pregunta = document.getElementById(`pregunta-${index}`);
      if (pregunta) pregunta.remove();
    }

    function eliminarOpcion(id) {
      const opcion = document.getElementById(`opcion-${id}`);
      if (opcion) opcion.remove();
    }

    function validarFormulario() {
      const preguntas = document.getElementById('preguntas-container').querySelectorAll('.pregunta');
      if (preguntas.length === 0) {
        alert("Debes agregar al menos una pregunta.");
        return false;
      }
      for (let i = 0; i < preguntas.length; i++) {
        const tipo = preguntas[i].querySelector(`select[name="preguntas[${i}][tipo]"]`)?.value;
        if (tipo === "cerrada") {
          const opciones = preguntas[i].querySelectorAll(`input[name="preguntas[${i}][opciones][]"]`);
          const tieneOpcion = Array.from(opciones).some(op => op.value.trim() !== "");
          if (!tieneOpcion) {
            alert(`La pregunta cerrada #${i + 1} necesita al menos una opción.`);
            return false;
          }
        }
        if (tipo === "escala") {
          const min = preguntas[i].querySelector(`input[name="preguntas[${i}][escalaMin]"]`)?.value;
          const max = preguntas[i].querySelector(`input[name="preguntas[${i}][escalaMax]"]`)?.value;
          if (min === "" || max === "" || parseInt(min) >= parseInt(max)) {
            alert(`Escala inválida en la pregunta #${i + 1}. Verifica los valores.`);
            return false;
          }
        }
      }
      return true;
    }
  </script>
</head>
<body class="bg-gray-100">
  <%- include('../partials/navbar') %>
  <div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6 text-purple-700 text-center">Crear Nueva Encuesta</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <!-- Formulario principal -->
      <form action="/encuestas/crear" method="POST" onsubmit="return validarFormulario()" class="md:col-span-2 space-y-4 bg-white p-6 rounded shadow">
        <div>
          <label class="block font-semibold mb-1">Título de la Encuesta:</label>
          <input type="text" name="titulo" class="w-full p-2 border rounded" required>
        </div>

        <div>
          <label class="block font-semibold mb-1">Descripción:</label>
          <textarea name="descripcion" rows="3" class="w-full p-2 border rounded"></textarea>
        </div>

        <div>
          <label class="block font-semibold mb-1">Tipo de Encuesta:</label>
          <select name="tipoEncuesta" class="w-full p-2 border rounded" required>
            <option value="abierta">Abierta</option>
            <option value="cerrada">Cerrada</option>
            <option value="escala">Escala</option>
          </select>
        </div>

        <div>
          <h2 class="text-xl font-semibold mt-6 mb-2">Preguntas</h2>
          <div id="preguntas-container"></div>
          <button type="button" onclick="agregarPregunta()"
                  class="mt-3 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
            Agregar Pregunta
          </button>
        </div>

        <div class="text-center">
          <button type="submit" class="mt-6 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
            Crear Encuesta
          </button>
        </div>
      </form>

      <!-- Segmentación -->
      <div class="bg-white p-6 rounded shadow space-y-4">
        <h2 class="text-xl font-semibold text-purple-700 mb-4">Segmentación</h2>

        <div>
          <label class="block font-semibold mb-1">Edad Mínima:</label>
          <input type="number" name="edadMin" min="0" class="w-full p-2 border rounded">
        </div>

        <div>
          <label class="block font-semibold mb-1">Edad Máxima:</label>
          <input type="number" name="edadMax" min="0" class="w-full p-2 border rounded">
        </div>

        <div>
          <label class="block font-semibold mb-1">Departamento (separado por comas):</label>
          <input type="text" name="departamento" placeholder="Ej: Antioquia, Cundinamarca" class="w-full p-2 border rounded">
        </div>

        <div>
          <label class="block font-semibold mb-1">Ocupación (separado por comas):</label>
          <input type="text" name="ocupacion" placeholder="Ej: Estudiante, Docente" class="w-full p-2 border rounded">
        </div>
      </div>
    </div>
  </div>
  <%- include('../partials/footer') %>
</body>
</html>
